<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="robots" content="noindex,nofollow">
    <title>Admin â€” Peakline</title>
    <script type="module" crossorigin src="/assets/index-Bcvwr-Er.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-Dun4DedU.css">
  </head>
  <body>
    <div id="root"></div>

    <!-- Dev-only client-side password overlay (same behavior as existing admin/index.html) -->
    <div id="admin-lock-overlay" style="position:fixed;inset:0;background:rgba(255,255,255,0.98);display:flex;align-items:center;justify-content:center;z-index:9999">
      <div style="width:360px;padding:24px;border:1px solid #eee;border-radius:8px;text-align:left;box-shadow:0 6px 24px rgba(16,24,40,0.08)">
        <h2 style="margin:0 0 8px">Admin login</h2>
        <div id="admin-message" style="color:#666;margin-bottom:12px">Protecting this admin area with a local password (dev-only).</div>
        <input id="admin-password" type="password" placeholder="Enter password" style="width:100%;padding:10px;margin-bottom:10px;border:1px solid #ddd;border-radius:6px">
        <div style="display:flex;gap:8px">
          <button id="admin-login" style="flex:1;padding:10px;border-radius:6px;border:0;background:#0b5cff;color:#fff">Login</button>
          <button id="admin-set" style="flex:1;padding:10px;border-radius:6px;border:1px solid #ddd;background:#fff">Set password</button>
        </div>
        <p style="margin-top:12px;color:#999;font-size:13px">Note: This is client-side only. For production use Netlify Identity / Access.</p>
      </div>
    </div>

    <script>
      // Same keys used by the site's admin overlay
      (function(){
        const STORAGE_KEY = 'peakline_admin_pwd_hash_v1';
        const SESSION_KEY = 'peakline_admin_authed_v1';

        const overlay = document.getElementById('admin-lock-overlay');
        const pwdInput = document.getElementById('admin-password');
        const loginBtn = document.getElementById('admin-login');
        const setBtn = document.getElementById('admin-set');
        const msg = document.getElementById('admin-message');

        async function sha256Hex(text){
          const enc = new TextEncoder().encode(text);
          const hash = await crypto.subtle.digest('SHA-256', enc);
          return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }

        function isAuthed(){
          return sessionStorage.getItem(SESSION_KEY) === '1';
        }

        async function checkPassword(pwd){
          const stored = localStorage.getItem(STORAGE_KEY);
          if(!stored) return false;
          const h = await sha256Hex(pwd);
          return h === stored;
        }

        async function setPassword(pwd){
          const h = await sha256Hex(pwd);
          localStorage.setItem(STORAGE_KEY, h);
        }

        function unlock(){
          sessionStorage.setItem(SESSION_KEY, '1');
          // also expose global flag for the app bundle
          window.__PEAKLINE_ADMIN_AUTHED__ = true;
          overlay.style.display = 'none';
        }

        // Initialize
        (async function(){
          if(isAuthed()){
            window.__PEAKLINE_ADMIN_AUTHED__ = true;
            overlay.style.display = 'none';
            return;
          }

          const hasStored = !!localStorage.getItem(STORAGE_KEY);
          if(!hasStored){
            msg.textContent = 'No admin password set. Create one now.';
            setBtn.textContent = 'Create';
          } else {
            msg.textContent = 'Enter the admin password to continue.';
            setBtn.textContent = 'Change';
          }
        })();

        loginBtn.addEventListener('click', async ()=>{
          const val = pwdInput.value || '';
          if(!val){ msg.textContent = 'Enter a password.'; return; }
          const ok = await checkPassword(val);
          if(ok){ unlock(); } else { msg.textContent = 'Incorrect password.'; }
        });

        setBtn.addEventListener('click', async ()=>{
          const val = pwdInput.value || '';
          if(!val){ msg.textContent = 'Enter a password to set.'; return; }
          const stored = !!localStorage.getItem(STORAGE_KEY);
          if(stored){
            const current = prompt('Enter current password to change it (cancel to abort):');
            if(!current) { msg.textContent='Password change canceled.'; return; }
            const ok = await checkPassword(current);
            if(!ok){ msg.textContent='Current password incorrect.'; return; }
          }
          await setPassword(val);
          msg.textContent = 'Password saved. You are now logged in for this session.';
          unlock();
        });
      })();
    </script>

  </body>
</html>
